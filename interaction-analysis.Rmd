---
title: "interaction-analysis"
author: "William Medwid"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: false
---

This analysis includes bottle rejectors and non-rejectors.

```{r setup, include=FALSE}
include_rejectors <- c(0, 1)
source("shared_setup.R")
```


## 1. Plot number of cues versus number of mom behaviors (per length of feeding) for dyads across ages, in total and for some of the specific cue-behavior comparisons in Dr. Ventura’s notes.

```{r}
p <- data_dyad_total_zeros %>% 
  group_by(id, dyad_set, dyad_unit) %>% 
  summarise(total_apm = sum(num_per_min), feeding_minutes = max(video_mins)) %>% 
  pivot_wider(id_cols = c(id, dyad_set), names_from = dyad_unit, values_from = c(total_apm, feeding_minutes)) %>% 
  ggplot(aes(x = total_apm_Baby, 
             y = total_apm_Mom, 
             col = dyad_set,
             text = paste("Mother:", total_apm_Mom,
                          "\nBaby:", total_apm_Baby,
                          "\nFeeding mins:", feeding_minutes_Baby,
                          "\nid:", id,
                          "\nDyad set:", dyad_set)
             )) +
  geom_point(alpha = 0.35) +
  geom_smooth(aes(x = total_apm_Baby, y = total_apm_Mom), method = "lm", inherit.aes = FALSE) + #the text aes broke geom_smooth, so it's removed.
  facet_grid(cols = vars(dyad_set)) +
  xlab("Baby cues per minute") +
  ylab("Mom behaviors per minute")

p %>%  ggplotly(tooltip = "text")
```



## 2. For each infant cue, what happens “next”?  How long?

```{r}
interaction_data <- data_duration %>% 
  group_by(id, dyad_set) %>% 
  mutate(next_dyad_unit = lead(dyad_unit),
         switch = if_else(next_dyad_unit == dyad_unit, 0, 1),
         chain_group = cumsum(switch) - switch) %>% #Switch = 1 at end of group, chain group changes at start of new group
  ungroup() %>% 
  mutate(next_behavior = if_else(switch == 1, lead(Behavior), NULL),
         next_time = if_else(switch == 1, lead(Time_Relative_sf), NULL)) %>% 
  group_by(id, dyad_set, chain_group) %>% 
  mutate(next_behavior = if_else(is.na(next_behavior), last(next_behavior), next_behavior),
         next_time = if_else(is.na(next_time), last(next_time), next_time),
         time_until_next = next_time - Time_Relative_sf)

# interaction_data %>% arrange(time_until_next)
# interaction_data %>% select(Time_Relative_sf, Behavior, dyad_unit, switch, chain_group, next_time, time_until_next) %>% arrange(time_until_next)
```

```{r heat_plot_function}
heat_plot <- function(interactions, used_next, title){
  interactions %>%
    filter(next_behavior %in% used_next) %>%
    ggplot(aes(y = Behavior,
               x = next_behavior,
               col = following_prop,
               text = paste("Behavior: ", Behavior,
                            "\nResponse: ", next_behavior,
                            "\nProp. following: ", round(following_prop, 2), " (", num_count, "/", n_total, ")",
                            sep=""))) +
    geom_point(shape = "square", size = 2.5) + #bootleg heatmap
    coord_equal() +
    scale_color_continuous(type = "viridis") +
    theme(axis.text.x = element_text(angle = 90, hjust= 1)) +
    ylab("Original behavior") +
    xlab("Response to behavior") +
    ggtitle(title)
}
heat_table <- function(interactions, used_next){
  interactions %>%
    mutate(prop_verbose = paste(round(following_prop, 2), " (", num_count, "/", n_total, ")", sep = "")) %>%
    filter(next_behavior %in% used_next) %>%
    pivot_wider(id_cols = Behavior, names_from = next_behavior, values_from = prop_verbose)
}
```


```{r}
infant_interactions <- interaction_data %>% 
  filter(dyad_unit == "Baby") %>% 
  filter(Time_Relative_sf > 0) %>% #Starting conditions don't really count
  group_by(Behavior, next_behavior) %>% 
  summarise(num_count = n()) %>% 
  group_by(Behavior) %>% 
  mutate(following_prop = num_count / sum(num_count),
         n_total = sum(num_count)) %>% 
  mutate(Behavior = reorder(Behavior, num_count, max), #These reorderings don't work as intended yet
         next_behavior = reorder(next_behavior, num_count, max))

responses = behavior_codebook %>% filter(dyad_unit == "Mom") %>% pull(Behavior)

infant_interactions %>% 
  heat_plot(responses, "First responses to infant behaviors") %>% 
  ggplotly(tooltip = "text")

infant_interactions %>% 
  heat_table(responses) %>% 
  kable()
```

```{r}
infant_interactions <- interaction_data %>% 
  filter(dyad_unit == "Baby") %>% 
  filter(Time_Relative_sf > 0) %>% #Starting conditions don't really count
  filter(!is.na(next_behavior)) %>%  
  mutate(next_behavior = get_group(next_behavior, "narrow")) %>% 
  group_by(Behavior, next_behavior) %>% 
  summarise(num_count = n()) %>% 
  group_by(Behavior) %>% 
  mutate(following_prop = num_count / sum(num_count),
         n_total = sum(num_count)) #%>% 
  # mutate(Behavior = reorder(Behavior, num_count, max), #These reorderings don't work as intended yet
  #        next_behavior = reorder(next_behavior, num_count, max))

responses <- behavior_codebook %>% filter(dyad_unit == "Mom") %>% pull(Narrow_group)

infant_interactions %>% 
  heat_plot(behavior_codebook %>% 
  filter(dyad_unit == "Mom") %>% pull(Narrow_group), "First responses to infant behaviors (by category)") %>% 
  ggplotly(tooltip = "text")

infant_interactions %>% 
  heat_table(responses) %>% 
  kable()
```

The following plots show the behavior following a group of behaviors.


## 3. For each mom behavior, what happened “before”? How long?

```{r}
mother_interactions <- interaction_data %>% 
  filter(dyad_unit == "Mom") %>% 
  group_by(Behavior, next_behavior) %>% 
  summarise(num_count = n()) %>% 
  group_by(Behavior) %>% 
  mutate(following_prop = num_count / sum(num_count),
         n_total = sum(num_count)) %>% 
  mutate(Behavior = reorder(Behavior, num_count, max), #These reorderings don't work as intended yet
         next_behavior = reorder(next_behavior, num_count, max))

responses <- behavior_codebook %>% filter(dyad_unit == "Baby") %>% pull(Behavior)

mother_interactions %>% 
  heat_plot(responses, "First responses to mother behaviors") %>% 
  ggplotly(tooltip = "text")

mother_interactions %>% 
  heat_table(responses) %>% 
  kable()
```

```{r}
mother_interactions <- interaction_data %>% 
  filter(dyad_unit == "Mom") %>% 
  filter(Time_Relative_sf > 0) %>% #Starting conditions don't really count
  filter(!is.na(next_behavior)) %>%
  mutate(next_behavior = get_group(next_behavior, "narrow")) %>% 
  group_by(Behavior, next_behavior) %>% 
  summarise(num_count = n()) %>% 
  group_by(Behavior) %>% 
  mutate(following_prop = num_count / sum(num_count),
         n_total = sum(num_count)) %>% 
  mutate(Behavior = reorder(Behavior, num_count, max), #These reorderings don't work as intended yet
         next_behavior = reorder(next_behavior, num_count, max))

mother_interactions %>% 
  heat_plot(behavior_codebook %>% 
  filter(dyad_unit == "Baby") %>% pull(Narrow_group), "First responses to mother behaviors") %>% 
  ggplotly(tooltip = "text")
```

### How long after each behavior is the response?

```{r}
interaction_data$time_until_next %>% 
  summary()

time_interactions <- interaction_data %>% 
  filter(!is.na(next_behavior)) %>% 
  group_by(Behavior, next_behavior, dyad_unit, dyad_set) %>% 
  summarise(num_count = n(),
            q1_time = quantile(time_until_next, 0.25),
            med_time = median(time_until_next),
            q3_time = quantile(time_until_next, 0.75))

p <- time_interactions %>% 
  filter(dyad_unit == "Baby") %>% 
  ggplot(aes(y = Behavior,
             x = next_behavior,
             col = med_time,
             text = paste("Behavior: ", Behavior,
                          "\nResponse: ", next_behavior,
                          "\nn :", num_count,
                          "\nTime between cue and response ---",
                          "\nq1 time: ", q1_time,
                          "\nMedian Time: ", as.character(med_time),
                          "\nq3 time: ", q3_time,
                          sep=""))) +
  geom_point(shape = "square", size = 3) + #bootleg heatmap
  scale_color_continuous(type = "viridis") +
  theme(axis.text.x = element_text(angle = 90, hjust= 1)) +
  coord_equal() +
#  facet_grid(cols = vars(dyad_set)) +
  ylab("Original behavior") +
  xlab("Response to behavior") +
  ggtitle("Baby cue response times")

p %>% ggplotly(tooltip = "text")

p <- time_interactions %>% 
  filter(dyad_unit == "Mom") %>% 
  ggplot(aes(y = Behavior,
             x = next_behavior,
             col = med_time,
             text = paste("Behavior: ", Behavior,
                          "\nResponse: ", next_behavior,
                          "\nn :", num_count,
                          "\nTime between cue and response ---",
                          "\nq1 time: ", q1_time,
                          "\nMedian Time: ", as.character(med_time),
                          "\nq3 time: ", q3_time,
                          sep=""))) +
  geom_point(shape = "square", size = 3) + #bootleg heatmap
  scale_color_continuous(type = "viridis") +
  theme(axis.text.x = element_text(angle = 90, hjust= 1)) +
  coord_equal() +
  ylab("Original behavior") +
  xlab("Response to behavior") +
  ggtitle("Mom behavior response times")

p %>% ggplotly(tooltip = "text")

```

Other than a few outliers, this mainly shows that most behaviors have similarly quick response times. Further analysis could reveal more significant differences.

