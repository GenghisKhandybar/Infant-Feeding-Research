---
title: "interaction-analysis"
author: "William Medwid"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: false
---

This analysis includes bottle rejectors and non-rejectors.

```{r setup, include=FALSE}
include_rejectors <- c(0, 1)
source("shared_setup.R")
```


## 1. Plot number of cues versus number of mom behaviors (per length of feeding) for dyads across ages, in total and for some of the specific cue-behavior comparisons in Dr. Ventura’s notes.

```{r}
p <- data_dyad_total_zeros %>% 
  group_by(id, dyad_set, dyad_unit) %>% 
  summarise(total_apm = sum(num_per_min), feeding_minutes = max(video_mins)) %>% 
  pivot_wider(id_cols = c(id, dyad_set), names_from = dyad_unit, values_from = c(total_apm, feeding_minutes)) %>% 
  ggplot(aes(x = total_apm_Baby, 
             y = total_apm_Mom, 
             col = dyad_set,
             text = paste("Mother:", total_apm_Mom,
                          "\nBaby:", total_apm_Baby,
                          "\nFeeding mins:", feeding_minutes_Baby,
                          "\nid:", id,
                          "\nDyad set:", dyad_set)
             )) +
  geom_point(alpha = 0.35) +
  geom_smooth(aes(x = total_apm_Baby, y = total_apm_Mom), method = "lm", inherit.aes = FALSE) + #the text aes broke geom_smooth, so it's removed.
  facet_grid(cols = vars(dyad_set)) +
  xlab("Baby cues per minute") +
  ylab("Mom behaviors per minute")

p %>%  ggplotly(tooltip = "text")
```



## 2. For each infant cue, what happens “next”?  How long?

<!-- interaction_data is now included in data_duration -->

```{r heat_plot_function}
process_interactions <- function(data_duration, dyad_unit_response, facet){
  
  data_processed <- data_duration %>% 
    filter(dyad_unit == dyad_unit_response) %>%
    filter(!is.na(next_behavior)) %>% 
    filter(Time_Relative_sf > 0) %>% #Starting conditions don't really count
    group_by(Behavior, next_behavior, !!as.name(facet)) %>% 
    #group_by(across(all_of(c("Behavior", "next_behavior", facet)))) %>% 
    summarise(num_count = n(),
            q1_time = quantile(time_until_next, 0.25),
            med_time = median(time_until_next),
            q3_time = quantile(time_until_next, 0.75)) %>% 
    ungroup()
  
  all_combos <- expand.grid(Behavior = data_processed %>% distinct(Behavior) %>% pull(),
                            next_behavior = data_processed %>% distinct(next_behavior) %>% pull(),
                            facet_place = data_processed %>% distinct(!!as.name(facet)) %>% pull())
  
  names(all_combos)[names(all_combos) == "facet_place"] <- facet
  
  data_processed %>%
    right_join(all_combos, on = c(Behavior, next_behavior, !!as.name(facet))) %>% 
    group_by(Behavior, !!as.name(facet)) %>% 
    mutate(across(c(num_count, q1_time, med_time, q3_time), .fns = ~replace_na(.,0))) %>% 
    #group_by(across(all_of(c("Behavior", facet)))) %>% 
    mutate(following_prop = num_count / sum(num_count),
           n_total = sum(num_count)) %>%
    mutate(following_prop = replace_na(following_prop, 0)) %>% 
    return()
}

#Faceted on dyad_set and bottle_state
process_interactions_full_facet <- function(data_duration, dyad_unit_response){
  
  data_processed <- data_duration %>% 
    filter(dyad_unit == dyad_unit_response) %>%
    filter(!is.na(next_behavior)) %>% 
    filter(Time_Relative_sf > 0) %>% #Starting conditions don't really count
    group_by(Behavior, next_behavior, dyad_set, bottle_state) %>% 
    summarise(num_count = n(),
            q1_time = quantile(time_until_next, 0.25),
            med_time = median(time_until_next),
            q3_time = quantile(time_until_next, 0.75)) %>% 
    ungroup()
  
  all_combos <- expand.grid(Behavior = data_processed %>% distinct(Behavior) %>% pull(),
                            next_behavior = data_processed %>% distinct(next_behavior) %>% pull(),
                            dyad_set = data_processed %>% distinct(dyad_set) %>% pull(),
                            bottle_state = data_processed %>% distinct(bottle_state) %>% pull())
  
  data_processed %>%
    right_join(all_combos, on = c(Behavior, next_behavior, dyad_set, bottle_state)) %>% 
    group_by(Behavior, dyad_set, bottle_state) %>% 
    mutate(across(c(num_count, q1_time, med_time, q3_time), .fns = ~replace_na(.,0))) %>% 
    #group_by(across(all_of(c("Behavior", facet)))) %>% 
    mutate(following_prop = num_count / sum(num_count),
           n_total = sum(num_count)) %>%
    mutate(following_prop = replace_na(following_prop, 0)) %>% 
    return()
}

heat_plot <- function(interactions, used_next, title){
  interactions %>%
    filter(next_behavior %in% used_next) %>%
    ggplot(aes(y = Behavior,
               x = next_behavior,
               col = following_prop,
               text = paste("Behavior: ", Behavior,
                            "\nResponse: ", next_behavior,
                            "\nProp. following: ", round(following_prop, 2), " (", num_count, "/", n_total, ")",
                            "\nTime between behavior and response ---",
                            "\nq1 time: ", round(q1_time, 2),
                            "\nMedian Time: ", round(med_time, 2),
                            "\nq3 time: ", round(q3_time, 2),
                            sep=""))) +
    geom_point(shape = "square", size = 2) + #bootleg heatmap
    coord_equal() +
    scale_color_continuous(type = "viridis") +
    theme(axis.text.x = element_text(angle = 90, hjust= 1)) +
    ylab("Original behavior") +
    xlab("Response to behavior") +
    ggtitle(title)
}

heat_table <- function(interactions, used_next, facet){
  interactions %>%
    mutate(prop_verbose = paste(round(following_prop, 2), " (", num_count, "/", n_total, ")", sep = "")) %>%
    filter(next_behavior %in% used_next) %>%
    pivot_wider(id_cols = c("Behavior", facet), names_from = next_behavior, values_from = prop_verbose) %>% 
    arrange(across(all_of(c(facet)))) %>% 
    return()
}
```


```{r first-set-infant}
infant_interactions <- data_duration %>% process_interactions("Baby", "bottle_state")

responses = behavior_codebook %>% filter(dyad_unit == "Mom") %>% pull(Behavior)

infant_interactions %>% 
  filter(bottle_state == "Bottle in mouth") %>% 
  heat_plot(responses, "First responses to infant behaviors - Bottle in mouth") %>% 
  ggplotly(tooltip = "text")

infant_interactions %>% 
  filter(bottle_state == "Bottle not in mouth") %>% 
  heat_plot(responses, "First responses to infant behaviors - Bottle not in mouth") %>% 
  ggplotly(tooltip = "text")

infant_interactions %>% 
  filter(bottle_state == "Bottle offered") %>% 
  heat_plot(responses, "First responses to infant behaviors - Bottle offered") %>% 
  ggplotly(tooltip = "text")


infant_interactions %>% 
  heat_table(responses, "bottle_state") %>% 
  kable()
```

```{r}
infant_interactions <- data_duration %>% 
  mutate(next_behavior = get_group(next_behavior, "narrow")) %>% 
  process_interactions("Baby", "dyad_set")

responses <- behavior_codebook %>% filter(dyad_unit == "Mom") %>% pull(Narrow_group)

p <- infant_interactions %>% 
  heat_plot(responses, "First responses to infant behaviors (by category)") + facet_grid(cols = vars(dyad_set))
p

infant_interactions %>% 
  heat_table(responses, "dyad_set") %>% 
  kable()
```

The following plots show the behavior following a group of behaviors.


## 3. For each mom behavior, what happened “before”? How long?

```{r}
mother_interactions <- data_duration %>% process_interactions("Mom", "bottle_state")
  # filter(dyad_unit == "Mom") %>% 
  # group_by(Behavior, next_behavior, bottle_state) %>% 
  # summarise(num_count = n()) %>% 
  # group_by(Behavior, bottle_state) %>% 
  # mutate(following_prop = num_count / sum(num_count),
  #        n_total = sum(num_count)) %>% 
  # mutate(Behavior = reorder(Behavior, num_count, max), #These reorderings don't work as intended yet
  #        next_behavior = reorder(next_behavior, num_count, max))

responses <- behavior_codebook %>% filter(dyad_unit == "Baby") %>% pull(Behavior)

mother_interactions %>% 
  filter(bottle_state == "Bottle in mouth") %>% 
  heat_plot(responses, "First responses to mother behaviors - Bottle in mouth") %>% 
  ggplotly(tooltip = "text")

mother_interactions %>% 
  filter(bottle_state == "Bottle not in mouth") %>% 
  heat_plot(responses, "First responses to mother behaviors - Bottle not in mouth") %>% 
  ggplotly(tooltip = "text")

mother_interactions %>% 
  filter(bottle_state == "Bottle offered") %>% 
  heat_plot(responses, "First responses to mother behaviors - Bottle offered") %>% 
  ggplotly(tooltip = "text")

mother_interactions %>% 
  heat_table(responses, "bottle_state") %>% 
  kable()
```

```{r}
infant_interactions <- data_duration %>% 
  mutate(next_behavior = get_group(next_behavior, "narrow")) %>% 
  process_interactions("Mom", "dyad_set")


responses <- behavior_codebook %>% filter(dyad_unit == "Baby") %>% pull(Narrow_group)

p <- infant_interactions %>% 
  heat_plot(responses, "First responses to mother behaviors (by category)") + facet_grid(cols = vars(dyad_set))
p %>% ggplotly(tooltip = "text")

infant_interactions %>% 
  heat_table(responses, "dyad_set") %>% 
  kable()
```

### How long after each behavior is the response?

```{r}
data_duration$time_until_next %>% 
  summary()

time_interactions <- data_duration %>% 
  filter(!is.na(next_behavior)) %>% 
  mutate(Behavior = Narrow_group,
       #next_behavior = get_group(next_behavior, "Narrow")
       ) %>% 
  group_by(Narrow_group, next_group_narrow, dyad_unit, dyad_set) %>% 
  summarise(num_count = n(),
            q1_time = quantile(time_until_next, 0.25),
            med_time = median(time_until_next),
            q3_time = quantile(time_until_next, 0.75))

p <- time_interactions %>% 
  filter(dyad_unit == "Baby") %>% 
  ggplot(aes(y = Narrow_group,
             x = next_group_narrow,
             col = med_time,
             text = paste("Behavior: ", Narrow_group,
                          "\nResponse: ", next_group_narrow,
                          "\nn :", num_count,
                          "\nTime between cue and response ---",
                          "\nq1 time: ", q1_time,
                          "\nMedian Time: ", as.character(med_time),
                          "\nq3 time: ", q3_time,
                          sep=""))) +
  geom_point(shape = "square", size = 3) + #bootleg heatmap
  scale_color_continuous(type = "viridis") +
  theme(axis.text.x = element_text(angle = 90, hjust= 1)) +
  coord_equal() +
  facet_grid(cols = vars(dyad_set)) +
  ylab("Original behavior") +
  xlab("Response to behavior") +
  ggtitle("Baby cue response times")

p %>% ggplotly(tooltip = "text")

p <- time_interactions %>% 
  filter(dyad_unit == "Mom") %>% 
  ggplot(aes(y = Narrow_group,
             x = next_group_narrow,
             col = med_time,
             text = paste("Behavior: ", Narrow_group,
                          "\nResponse: ", next_group_narrow,
                          "\nn :", num_count,
                          "\nTime between cue and response ---",
                          "\nq1 time: ", q1_time,
                          "\nMedian Time: ", as.character(med_time),
                          "\nq3 time: ", q3_time,
                          sep=""))) +
  geom_point(shape = "square", size = 3) + #bootleg heatmap
  scale_color_continuous(type = "viridis") +
  theme(axis.text.x = element_text(angle = 90, hjust= 1)) +
  coord_equal() +
  facet_grid(cols = vars(dyad_set)) +
  ylab("Original behavior") +
  xlab("Response to behavior") +
  ggtitle("Mom behavior response times")

p %>% ggplotly(tooltip = "text")
```

Other than a few outliers, this mainly shows that most behaviors have similarly quick response times. Further analysis could reveal more significant differences.

# Faceted by dyad_set and bottle state

## Baby cues

```{r}
interaction_data <- data_duration %>% 
  mutate(Behavior = Narrow_group, next_behavior = next_group_narrow) %>% 
  process_interactions_full_facet("Baby")

responses = behavior_codebook %>% filter(dyad_unit == "Mom") %>% pull(Narrow_group)

p <- interaction_data %>% 
  filter(bottle_state == "Bottle in mouth") %>% 
  heat_plot(responses, "First responses to baby behaviors - Bottle in mouth") +
  facet_grid(cols = vars(dyad_set))
p  %>% ggplotly(tooltip = "text")

p <- interaction_data %>% 
  filter(bottle_state == "Bottle not in mouth") %>% 
  heat_plot(responses, "First responses to baby behaviors - Bottle not in mouth") +
  facet_grid(cols = vars(dyad_set))
p  %>% ggplotly(tooltip = "text")

p <- interaction_data %>% 
  filter(bottle_state == "Bottle offered") %>% 
  heat_plot(responses, "First responses to baby behaviors - Bottle offered") +
  facet_grid(cols = vars(dyad_set))
p  %>% ggplotly(tooltip = "text")
```

## Mom behaviors

```{r}
interaction_data <- data_duration %>% 
  mutate(Behavior = Narrow_group, next_behavior = next_group_narrow) %>% 
  process_interactions_full_facet("Mom")

responses = behavior_codebook %>% filter(dyad_unit == "Baby") %>% pull(Narrow_group)

p <- interaction_data %>% 
  filter(bottle_state == "Bottle in mouth") %>% 
  heat_plot(responses, "First responses to mom behaviors - Bottle in mouth") +
  facet_grid(cols = vars(dyad_set))
p  %>% ggplotly(tooltip = "text")

p <- interaction_data %>% 
  filter(bottle_state == "Bottle not in mouth") %>% 
  heat_plot(responses, "First responses to mom behaviors - Bottle not in mouth") +
  facet_grid(cols = vars(dyad_set))
p  %>% ggplotly(tooltip = "text")

p <- interaction_data %>% 
  filter(bottle_state == "Bottle offered") %>% 
  heat_plot(responses, "First responses to mom behaviors - Bottle offered") +
  facet_grid(cols = vars(dyad_set))
p  %>% ggplotly(tooltip = "text")
```

## Behaviors until a response

### Baby cues

```{r}
data_duration %>% 
  filter(dyad_unit == "Baby" & Narrow_group == "Subtle") %>% 
  ggplot(aes(x = remaining_cues, y = Behavior, col = dyad_set)) +
  geom_boxplot() +
  ggtitle("Baby cues before a response")

data_duration %>% 
  filter(dyad_unit == "Baby" & Narrow_group == "Potent") %>% 
  ggplot(aes(x = remaining_cues, y = Behavior, col = dyad_set)) +
  geom_boxplot() +
  ggtitle("Baby cues before a response")

data_duration %>% 
  filter(dyad_unit == "Baby") %>% 
  group_by(Behavior, dyad_set) %>% 
  summary_5_num("remaining_cues") %>% 
  arrange(Behavior, dyad_set) %>% 
  kable()
```

### Mom behaviors

```{r}
mom_narrow_groups <- behavior_codebook %>% filter(dyad_unit == "Mom") %>% distinct(Wide_group) %>% pull()

for(t in mom_narrow_groups){
  p <- data_duration %>% 
    filter(Wide_group == t) %>% 
    ggplot(aes(x = remaining_cues, y = Behavior, col = dyad_set)) +
    geom_boxplot() +
    ggtitle("Mom behaviors remaining before a response")
  p %>% print()
}

data_duration %>% 
  filter(dyad_unit == "Mom") %>% 
  group_by(Behavior, dyad_set) %>% 
  summary_5_num(to_summarise = "remaining_cues") %>% 
  arrange(Behavior, dyad_set) %>% 
  kable()
```

