---
title: "interaction-analysis"
author: "William Medwid"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: false
---

This analysis includes bottle rejectors and non-rejectors.

```{r setup, include=FALSE}
include_rejectors <- c(0, 1)
source("shared_setup.R")
```


## 1. Plot number of cues versus number of mom behaviors (per length of feeding) for dyads across ages, in total and for some of the specific cue-behavior comparisons in Dr. Ventura’s notes.

```{r}
p <- data_dyad_total_zeros %>% 
  group_by(id, dyad_set, dyad_unit) %>% 
  summarise(total_apm = sum(num_per_min), feeding_minutes = max(video_mins)) %>% 
  pivot_wider(id_cols = c(id, dyad_set), names_from = dyad_unit, values_from = c(total_apm, feeding_minutes)) %>% 
  ggplot(aes(x = total_apm_Baby, 
             y = total_apm_Mom, 
             col = dyad_set,
             text = paste("Mother:", total_apm_Mom,
                          "\nBaby:", total_apm_Baby,
                          "\nFeeding mins:", feeding_minutes_Baby,
                          "\nid:", id,
                          "\nDyad set:", dyad_set)
             )) +
  geom_point(alpha = 0.35) +
  geom_smooth(aes(x = total_apm_Baby, y = total_apm_Mom), method = "lm", inherit.aes = FALSE) + #the text aes broke geom_smooth, so it's removed.
  facet_grid(cols = vars(dyad_set)) +
  xlab("Baby cues per minute") +
  ylab("Mom behaviors per minute")

p %>%  ggplotly(tooltip = "text")
```



## 2. For each infant cue, what happens “next”?  How long?

The following plots display the prevalence of each mother reaction to each infant cue. The following plot only shows behaviors directly following an infant behavior.

```{r}
infant_interactions <- data_duration %>%
  mutate(next_behavior = lead(Behavior), next_dyad_unit = lead(dyad_unit)) %>% 
  filter(dyad_unit == "Baby") %>% 
  filter(next_dyad_unit == "Mom") %>%
  group_by(Behavior, next_behavior) %>% 
  summarise(num_count = n()) %>% 
  group_by(Behavior) %>% 
  mutate(following_prop = num_count / sum(num_count),
         n_total = sum(num_count)) %>% 
  mutate(Behavior = reorder(Behavior, num_count, max), #These reorderings don't work as intended yet
         next_behavior = reorder(next_behavior, num_count, max))



heat_plot <- function(infant_interactions, used_next, title){
  infant_interactions %>% 
    filter(next_behavior %in% used_next) %>% 
    ggplot(aes(y = Behavior, 
               x = next_behavior, 
               col = following_prop,
               text = paste("Behavior: ", Behavior,
                            "\n Response: ", next_behavior,
                            "\nProp. following: ", round(following_prop, 2), " (", num_count, "/", n_total, ")",
                            sep=""))) +
    geom_point(shape = "square", size = 2.5) + #bootleg heatmap
    coord_equal() +
    scale_color_continuous(type = "viridis") +
    theme(axis.text.x = element_text(angle = 90, hjust= 1)) +
    ylab("Original behavior") +
    xlab("Response to behavior") +
    ggtitle(title)
}
# Plots split by prevelance ----

# top_mom_behaviors <- infant_interactions %>% 
#   group_by(next_behavior) %>% 
#   summarise(n = max(num_count)) %>% 
#   arrange(n) %>% 
#   top_n(3) %>% 
#   pull(next_behavior)
# 
# bottom_mom_behaviors <- behavior_codebook %>% 
#   filter(dyad_unit == "Mom") %>% 
#   filter(!Behavior %in% top_mom_behaviors) %>% 
#   pull(Behavior)
# 
# infant_interactions %>% 
#   heat_plot(top_mom_behaviors, "Most common mother behaviors") %>% 
#   ggplotly(tooltip = "text")
# 
# infant_interactions %>% 
#   heat_plot(bottom_mom_behaviors, "Least common mother behaviors") %>% 
#   ggplotly()

infant_interactions %>% 
  heat_plot(behavior_codebook %>% 
  filter(dyad_unit == "Mom") %>% pull(Behavior), "Immediate responses to infant behaviors") %>% 
  ggplotly(tooltip = "text")
```

The following plots show the behavior following a group of behaviors.

```{r}
interaction_data <- data_duration %>% 
  mutate(next_dyad_unit = lead(dyad_unit),
         switch = if_else(next_dyad_unit == dyad_unit, 0, 1)) %>% 
  group_by(id, dyad_set) %>% 
  mutate(chain_group = cumsum(switch) - switch) %>%  #Switch == 1 at end of group, chain group changes at start of new group
  ungroup() %>% 
  mutate(next_behavior = if_else(switch == 1, lead(Behavior), "NA")) %>% 

  group_by(id, dyad_set, chain_group) %>% 
  mutate(next_behavior = if_else(next_behavior == "NA", last(next_behavior), next_behavior))
    
infant_interactions <- interaction_data %>% 
  filter(dyad_unit == "Baby") %>% 
  group_by(Behavior, next_behavior) %>% 
  summarise(num_count = n()) %>% 
  group_by(Behavior) %>% 
  mutate(following_prop = num_count / sum(num_count),
         n_total = sum(num_count)) %>% 
  mutate(Behavior = reorder(Behavior, num_count, max), #These reorderings don't work as intended yet
         next_behavior = reorder(next_behavior, num_count, max))

infant_interactions %>% 
  heat_plot(behavior_codebook %>% 
  filter(dyad_unit == "Mom") %>% pull(Behavior), "First responses to infant behaviors") %>% 
  ggplotly(tooltip = "text")
```




## 3. For each mom behavior, what happened “before”? How long?

```{r}
mother_interactions <- interaction_data %>% 
  filter(dyad_unit == "Mom") %>% 
  group_by(Behavior, next_behavior) %>% 
  summarise(num_count = n()) %>% 
  group_by(Behavior) %>% 
  mutate(following_prop = num_count / sum(num_count),
         n_total = sum(num_count)) %>% 
  mutate(Behavior = reorder(Behavior, num_count, max), #These reorderings don't work as intended yet
         next_behavior = reorder(next_behavior, num_count, max))

mother_interactions %>% 
  heat_plot(behavior_codebook %>% 
  filter(dyad_unit == "Baby") %>% pull(Behavior), "First responses to mother behaviors") %>% 
  ggplotly(tooltip = "text")
```

### TODO next: how long after?