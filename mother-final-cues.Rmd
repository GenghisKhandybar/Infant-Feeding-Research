---
title: "mother-final-cues"
author: "William Medwid"
date: "7/7/2021"
output: 
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
---

This analysis excludes bottle rejectors.

# Time-based analsis of mothers' behaviors

```{r setup, include=FALSE}
include_rejectors <- c(0)
source("shared_setup.R")
```

```{r final_cues}
final_cue <- data_duration %>% 
  filter(dyad_unit == "Mom") %>% 
  group_by(id, dyad_set) %>% 
  slice_max(order_by=Time_Relative_sf, n=1) %>% 
  mutate(time_before_end = video_length - end_time)

last_cue_counts <- final_cue %>% 
  group_by(dyad_set) %>% 
  count(Behavior)
  
n_dyads <- last_cue_counts %>% group_by(dyad_set) %>% summarise(n_dyads = sum(n))

#Creating proportion variable
last_cue_counts <- last_cue_counts %>% 
  left_join(n_dyads,
    on=dyad_set) %>% 
  mutate(prop_dyads = n/n_dyads)

# Checksum for proportions
#last_cue_counts %>% group_by(dyad_set) %>% summarise(n = sum(n), prop_sum = sum(prop_dyads))

#Plot

last_cue_counts %>% 
  ggplot(aes(y=reorder(Behavior, desc(prop_dyads)), 
             x=prop_dyads*100, 
             fill = dyad_set)) +
  geom_bar(stat="identity") +
  facet_grid(cols = vars(dyad_set)) +
  ylab("Final behavior") +
  xlab("Percent of final behaviors") +
  ggtitle("Mothers' final behaviors before end of session")+ 
  theme(legend.position = "none") #The fill colors are purely aesthetic so the legend is removed.
```

Predictably, the large majority of sessions end with an indication that the session is over.

```{r last_quarter}
num_splits = 4

near_final_cues =  data_duration %>% 
  filter(dyad_unit == "Mom") %>% 
  filter(Event_Type == "State point") %>% 
  mutate(split = get_time_split(start_fraction, num_splits)) %>% 
  filter(split == num_splits) %>% 
  #filter(start_fraction > after_prop) %>% 
  distinct(Behavior, dyad_set, id) #Removes repeated cues from the same infant within the same feeding

last_cue_counts <- near_final_cues %>% 
  group_by(dyad_set) %>% 
  count(Behavior)
  

#Creating proportion variable
combinations <- expand_grid(Behavior = near_final_cues %>% distinct(Behavior) %>% pull(), 
            dyad_set = last_cue_counts %>% distinct(dyad_set) %>% pull())



last_cue_counts <- combinations %>% 
  left_join(last_cue_counts) %>% 
  mutate(n = replace_na(n, 0)) %>% 
  left_join(n_dyads,
            on=dyad_set) %>% 
  mutate(prop_dyads = n/n_dyads,
         Behavior = reorder(Behavior, desc(prop_dyads))) %>% 
  mutate(pct_dyads = prop_dyads*100)

# #Creating proportion variable
# last_cue_counts <- last_cue_counts %>% 
#   left_join(n_dyads,
#             on=dyad_set) %>% 
#   mutate(pct_dyads = 100*n/n_dyads,
#          Behavior = reorder(Behavior, desc(pct_dyads)))

# Table -----------

verbose_props <- last_cue_counts %>% 
  mutate(prop_dyads_verbose = paste(
    round(prop_dyads, 2) ,#%>% str_pad(width=4, side="right", pad="0"),
    " (", n, "/", n_dyads, ")", sep = "")) %>% 
  pivot_wider(names_from = dyad_set, 
              values_from = prop_dyads_verbose, 
              id_cols = Behavior)
verbose_props %>% 
  arrange(verbose_props %>% select("6moB")) %>% 
  kable(caption="Proportion of mothers displaying each behavior in the last 25% of feeding")

# Plot ----------

#This was originally done with a loop, but plotly doesn't plot within loops.
line_plot <- function(group){
  behaviors <- behavior_codebook %>% filter(Wide_group == group) %>% pull(Behavior)

  p <- last_cue_counts %>% 
    filter(Behavior %in% behaviors) %>% 
    ggplot(aes(color=Behavior, 
               group=Behavior,
               y=pct_dyads, 
               x = dyad_set)) +
    geom_point() +
    geom_line() +
    ylim(0,100) +
    ylab("Percent expressing behavior") +
    xlab("Dyad set") +
    ggtitle(paste("Mothers displaying", group, "behaviors at least once in the final 25% of feeding"))
  
  p %>% 
    ggplotly() %>% 
    return()
}
line_plot("Controlling")
line_plot("Responsive")
```

Responsive behaviors in the final quarter appear about constant, while some controlling behaviors become less common.

```{r distribution_plot}
df_points <- data_duration %>% 
  filter(dyad_unit == "Mom" & Event_Type == "State point") %>% 
  filter(Behavior != "Indicates feeding is over")

med_times <- df_points %>% 
  group_by(Behavior) %>% 
  summarise(med_time = median(start_fraction)) %>%
  arrange(med_time) %>% 
  pull(Behavior)

df_points %>% 
  ggplot(aes(y=factor(Behavior, levels=med_times), x=start_fraction*100)) +
  geom_violin(aes(fill=dyad_set))+
  geom_boxplot(width=0.2, outlier.shape = NA, coef = 0) +
  facet_grid(cols = vars(dyad_set)) +
  ylab("Behavior") +
  xlab("Percent of feeding completed") +
  ggtitle("Shape and center 50 percentile of behavior times") +
  theme(legend.position = "none") #The fill colors are purely aesthetic so the legend is removed.
```

```{r distribution_table}
#Table ---------------
df_points <- data_duration %>% 
  filter(dyad_unit == "Mom" & Event_Type == "State point")

df_points %>%
  group_by(Behavior, dyad_set) %>%
  summarise(q1 = quantile(start_fraction, 0.25),
            median = median(start_fraction),
            q3 = quantile(start_fraction, 0.75), 
            total_expressions = n(), 
            dyads_expressing = n_distinct(dyad_set, id)) %>%
  kable(digits=2, caption = "When behaviors happen within the feeding, proportionally")
```

